<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <title>일해라 너구리</title>
</head>

<main class="container chat-container">
    <!-- 타이틀 -->
    <h1 class="chat-title">일해라 너구리</h1>
    <h2 class="chat-subtitle">너구리톡</h2>

    <!-- 검색 폼 -->
    <div class="search-box">
        <form id="search-form" method="GET" action="/board/search">
            <select class="search-type" id="search-type" name="searchType">
                <option>글 한 마디</option>
                <option>닉네임</option>
                <option>해시태그</option>
            </select>
            <input type="text" placeholder="검색어..." id="search-value" name="searchValue">
            <button type="submit"><i class="bi bi-search"></i></button>
        </form>
    </div>

    <!-- 채팅 스타일 게시글 목록 -->
    <div class="chat-box" id="chat-box">
        <% posts.forEach(post => { %>
            <div class="chat-message-card <% if (user && user.username === post.author) { %> right <% } else { %> left <% } %>">
                <div class="chat-profile-box">
                    <img src="/default-profile.png" class="chat-profile">
                </div>
                <div class="chat-content">
                    <div class="chat-author"><%= post.author %> 센터</div>
                    <div class="chat-text"><%= post.title %></div>
                    <div class="chat-time"><%= post.created_at %></div>
                </div>
                <% if (user && user.username === post.author) { %>
                    <button class="delete-btn" onclick="deletePost(<%= post.id %>)">
                        <i class="bi bi-trash"></i>
                    </button>
                <% } %>
            </div>
        <% }); %>
    </div>

    <!-- 입력창 -->
    <div class="chat-input-box">
        <textarea id="chat-input" placeholder="한마디를 입력하세요 (최대 50자)" maxlength="50"></textarea>
        <button id="send-btn"><i class="bi bi-send"></i></button>
    </div>
</main>

<script>
    function deletePost(postId) {
        if (!confirm("정말 삭제하시겠습니까?")) return;
        fetch(`/board/delete/${postId}`, { method: 'GET' })
            .then(response => response.ok ? location.reload() : alert("삭제 실패"))
            .catch(error => console.error("삭제 에러:", error));
    }

    document.getElementById('send-btn').addEventListener('click', sendMessage);
    document.getElementById('chat-input').addEventListener('keypress', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    });

    function sendMessage() {
        const inputField = document.getElementById('chat-input');
        const message = inputField.value.trim();
        if (!message) return;
        fetch('/board/write', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: message })
        }).then(response => {
            if (response.ok) {
                inputField.value = '';
                location.reload();
            }
        }).catch(error => console.error('에러 발생:', error));
    }
</script>
