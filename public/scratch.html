<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
    style-src-elem 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://apis.google.com https://code.jquery.com https://cdn.jsdelivr.net;
    script-src-elem 'self' 'unsafe-inline' 'unsafe-eval' https://apis.google.com https://code.jquery.com https://cdn.jsdelivr.net;
    font-src 'self' data: https://cdnjs.cloudflare.com https://fonts.googleapis.com https://fonts.gstatic.com;
    frame-src 'self' https://docs.google.com https://sheets.googleapis.com https://content-sheets.googleapis.com https://educodingnplaycontents.s3.amazonaws.com;
    ">

    <title>Scratch 콘텐츠 선택</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.5.0/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/public/styles.css">
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            gapi.load('client', initClient);
        });

        function initClient() {
            gapi.client.init({
                apiKey: 'AIzaSyAZqp7wFA6uQtlyalJMayyNffqhj1rVgLk',
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            }).then(() => {
                loadSB2Data();
            }).catch(error => console.error('Error initializing Google API client', error));
        }

        function loadSB2Data() {
            const spreadsheetId = '1yEb5m_fjw3msbBYLFtO55ukUI0C0XkJfLurWWyfALok';
            const range = 'sb2!A2:C';

            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: spreadsheetId,
                range: range,
            }).then((response) => {
                const data = response.result.values;
                if (data) {
                    const projects = groupByProject(data);
                    displayProjects(projects);
                }
            }).catch(error => console.error('Error loading SB2 data', error));
        }

        function groupByProject(data) {
            const projects = {};
            data.forEach(row => {
                const [name, url, ctElement] = row;
                const baseName = name.replace(/(\(기본\)|\(확장1\)|\(확장2\))/, '').trim();
                if (!projects[baseName]) {
                    projects[baseName] = { ctElement: ctElement, basic: '', ext1: '', ext2: '' };
                }
                if (name.includes('(기본)')) {
                    projects[baseName].basic = url;
                } else if (name.includes('(확장1)')) {
                    projects[baseName].ext1 = url;
                } else if (name.includes('(확장2)')) {
                    projects[baseName].ext2 = url;
                }
            });
            return projects;
        }

        function displayProjects(projects) {
            const container = document.getElementById('content-container');
            Object.keys(projects).forEach(projectName => {
                if (projectName === '새로 시작하기') return;

                const project = projects[projectName];
                const card = document.createElement('div');
                card.className = 'col-lg-3 col-md-4 col-sm-6 mb-4';

                const cardContent = `
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">${projectName}</h5>
                            <p class="card-text"><i class="bi bi-cpu"></i> C.T 학습 요소: ${project.ctElement || '정보 없음'}</p>
                            <p class="card-text">이 콘텐츠를 통해 재미있는 프로젝트를 경험해보세요.</p>
                            ${project.basic ? `<button class="btn btn-primary load-sb2" data-url="${project.basic}">기본</button>` : ''}
                            ${project.ext1 ? `<button class="btn btn-secondary load-sb2" data-url="${project.ext1}">확장1</button>` : ''}
                            ${project.ext2 ? `<button class="btn btn-secondary load-sb2" data-url="${project.ext2}">확장2</button>` : ''}
                        </div>
                    </div>
                `;
                card.innerHTML = cardContent;
                container.appendChild(card);
            });
        }
    </script>
</head>
<body>
    <!-- Include header.html -->
    <div id="headerContainer"></div>

    <div class="container mt-5">
        <h1 class="text-center">Scratch 콘텐츠 선택</h1>
        <div class="text-center mb-4">
            <button id="newStartButton" class="btn btn-success">새로 시작하기</button>
        </div>
        <div class="row" id="content-container">
            <!-- SB2 파일 카드 목록이 여기에 동적으로 추가됩니다 -->
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(function(){
            $("#headerContainer").load("/public/header.html", function() {
                initializeHeader(); // header.html이 로드된 후에 초기화 함수 실행
            });

            // "새로 시작하기" 버튼 클릭 시 :8601로 전환
            $("#newStartButton").click(function() {
                window.location.href = "http://3.34.127.154:8601";
            });

            // 기본/확장1/확장2 버튼 클릭 시 :8601로 전환하고 sb2 파일 불러오기
            $(document).on("click", ".load-sb2", function() {
                const sb2Url = $(this).data("url");
                window.location.href = `http://3.34.127.154:8601#${sb2Url}`;
            });
        });

        function initializeHeader() {
            // 세션 유지
            fetch('/get-user')
                .then(response => response.json())
                .then(data => {
                    document.getElementById("userEmail").innerText = data.email || "로그인 정보 미확인";
                })
                .catch(error => {
                    console.error('Error fetching user data:', error);
                    document.getElementById("userEmail").innerText = "로그인 정보 미확인";
                });

            // 로그아웃 버튼 클릭 이벤트
            const logoutButton = document.getElementById("logoutButton");
            if (logoutButton) {
                logoutButton.addEventListener("click", function() {
                    fetch('/auth/logout', { method: 'GET' })
                        .then(() => {
                            window.location.href = '/auth/login'; // 로그아웃 후 로그인 페이지로 리디렉션
                        })
                        .catch(error => console.error('Error logging out:', error));
                });
            } else {
                console.error("Logout button not found");
            }
        }
    </script>
</body>
</html>
