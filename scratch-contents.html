<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스크래치 콘텐츠 목록</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            display: flex;
            justify-content: flex-start;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-left: 0; /* 테이블을 페이지 왼쪽에 정렬 */
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        tr:hover {
            background-color: #ddd;
        }

        th {
            padding-top: 12px;
            padding-bottom: 12px;
            background-color: #4CAF50;
            color: white;
        }

        tr {
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="content-view">
        <table>
            <thead>
                <tr>
                    <th>콘텐츠명</th>
                </tr>
            </thead>
            <tbody id="contentList"></tbody>
        </table>
    </div>
    
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>

    <script>
        // Firebase 초기화
        const firebaseConfig = {
            apiKey: "AIzaSyAZqp7wFA6uQtlyalJMayyNffqhj1rVgLk",
            authDomain: "educodingnplay.firebaseapp.com",
            projectId: "educodingnplay",
            storageBucket: "educodingnplay.appspot.com",
            messagingSenderId: "1042775751985",
            appId: "1:1042775751985:web:fb39bc05054ed63cadc410"
        };
        firebase.initializeApp(firebaseConfig);

        // Google Sheets API로 데이터 가져오기
        function loadContentData() {
            const apiKey = firebaseConfig.apiKey;
            const spreadsheetId = '1yEb5m_fjw3msbBYLFtO55ukUI0C0XkJfLurWWyfALok';
            const range = 'sb2!A2:B';

            gapi.client.init({
                apiKey: apiKey,
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            }).then(function () {
                return gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: spreadsheetId,
                    range: range,
                });
            }).then(function (response) {
                const data = response.result.values;
                if (data) {
                    const contentList = document.getElementById('contentList');
                    contentList.innerHTML = '';
                    data.forEach(function (row) {
                        const contentName = row[0];
                        const sb2Url = row[1];
                        const contentRow = document.createElement('tr');
                        const nameCell = document.createElement('td');
                        nameCell.textContent = contentName;
                        contentRow.appendChild(nameCell);
                        contentRow.addEventListener('click', function () {
                            loadSB2(sb2Url);
                        });
                        contentList.appendChild(contentRow);
                    });
                }
            }).catch(function (error) {
                console.error('Error loading data from Google Sheets:', error);
            });
        }

        gapi.load('client', function() {
            gapi.client.load('sheets', 'v4', loadContentData);
        });

        function loadSB2(sb2Url) {
            window.open(`http://3.34.127.154:8601/?project_url=${encodeURIComponent(sb2Url)}`, '_blank');
        }

        // Firebase 인증 및 사용자 데이터 저장
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                user.getIdToken().then(function(idToken) {
                    fetch('/save-user', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}`
                        },
                        body: JSON.stringify({
                            firebase_uid: user.uid,
                            email: user.email,
                            name: user.displayName
                        })
                    }).then(function(response) {
                        if (response.ok) {
                            console.log('User data saved successfully.');
                        } else {
                            console.error('Failed to save user data.');
                        }
                    }).catch(function(error) {
                        console.error('Error saving user data:', error);
                    });
                });
            }
        });
    </script>
</body>
</html>
